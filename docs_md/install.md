# インストール￹方法￺ほうほう￻

　「ひらがなIME」を￹利用￺りよう￻できるようにするには、つぎの￹手順￺てじゅん￻でセットアップをすすめていきます。

1. [「ひらがなIME」のソフトウェア パッケージをインストールする](#install)
2. [「ひらがなIME」をOSの入力ソースに￹追加￺ついか￻する](#input-source)
3. [「ひらがなIME」を￹有効￺ゆうこう￻にする](#enable)
4. [￹大規模￺だいきぼ￻￹言語￺げんご￻モデルをインストールする](#llm)

## ソフトウェア パッケージをインストールする {: #install}

　FedoraかUbuntuをつかっているときは、かんたんなコマンドで「ひらがなIME」をインストールすることができます。

### Fedoraのばあい

　Fedora￹用￺よう￻のソフトウェア パッケージはCoprプロジェクト「[@esrille/releases](https://copr.fedorainfracloud.org/coprs/g/esrille/releases/)」から￹提供￺ていきょう￻しています。
このCoprプロジェクトを￹有効￺ゆうこう￻にするには、いちど、コマンドラインからつぎのように￹実行￺じっこう￻します。

```
sudo dnf copr enable @esrille/releases
```

　そのあとは、いつものように、dnfコマンドで「ひらがなIME」をインストールできます。

```
sudo dnf update
sudo dnf install ibus-hiragana
```

### Ubuntuのばあい

　Ubuntu￹用￺よう￻のソフトウェア パッケージはPPAレポジトリ「[esrille/releases](https://launchpad.net/~esrille/+archive/ubuntu/releases)」から￹提供￺ていきょう￻しています。
このPPAレポジトリを￹有効￺ゆうこう￻にするには、いちど、コマンドラインからつぎのように￹実行￺じっこう￻します。

```
sudo add-apt-repository ppa:esrille/releases
```

　そのあとは、いつものように、aptコマンドで「ひらがなIME」をインストールできます。
```
sudo apt update
sudo apt install ibus-hiragana
```

### Wayland￹用￺よう￻のインプットメソッドモジュールを￹変更￺へんこう￻をする {: #wayland}

　Ubuntu 21.04￹以降￺いこう￻やFedora 25￹以降￺いこう￻では、デフォルトで￹画面￺がめん￻の￹描画￺びょうが￻にWaylandをつかうようになっています。
Waylandは、ながくつかわれてきたXサーバーをおきかえるものです。

　GNOMEではWayland￹用￺よう￻のあたらしいインプットメソッドモジュールも￹開発￺かいはつ￻しています。
ただ、まだ￹開発￺かいはつ￻￹途中￺とちゅう￻の￹部分￺ぶぶん￻がのこっています。
GNOME 45￹以前￺いぜん￻のシステムでは、ただしい￹周辺￺しゅうへん￻テキストの￹情報￺じょうほう￻がIMEにおくられてきません。
またGNOME 46￹以降￺いこう￻でも、￹主要￺しゅよう￻なアプリケーションソフトウェアの￹挙動￺きょどう￻がかわってしまうという￹問題￺もんだい￻がのこっています。

　「ひらがなIME」を￹使用￺しよう￻するときは、WaylandでもIBusのインプットメソッドモジュールをつかうことをおすすめします。
そのためには、つぎの￹行￺ぎょう￻を <code>~/.bash_profile</code> (Fedoraなど)か、<code>~/.profile</code> (Ubuntuなど)に￹追加￺ついか￻してください。

```
export GTK_IM_MODULE=ibus
```

　GNOMEのバージョンは、GNOMEの[￹設定￺せってい￻]ウィンドウをひらいて、[このシステムについて]—[システムの￹詳細￺しょうさい￻￹設定￺せってい￻]をしらべると￹確認￺かくにん￻できます。

### PCを￹再￺さい￻￹起動￺きどう￻する

　ここまでの￹手順￺てじゅん￻をおえたら、いちどPCを￹再￺さい￻￹起動￺きどう￻してください。

## OSの￹入力￺にゅうりょく￻ソースに￹追加￺ついか￻する {: #input-source}

　つづいて、OSの「￹入力￺にゅうりょく￻ソース」に「ひらがなIME」を￹追加￺ついか￻します。
GNOMEでは、キーボード￹配列￺はいれつ￻やインプット メソッドのことをまとめて「￹入力￺にゅうりょく￻ソース」とよんでいます。
￹入力￺にゅうりょく￻ソースの￹設定￺せってい￻のしかたは、デスクトップ￹環境￺かんきょう￻によってすこし￹異￺こと￻なります。

### GNOMEを￹利用￺りよう￻しているとき

　FedoraやUbuntuでは、GNOMEが￹標準￺ひょうじゅん￻のデスクトップ￹環境￺かんきょう￻になっています。GNOMEを￹利用￺りよう￻しているときは、GNOMEの「￹設定￺せってい￻」をひらいて、「キーボード」の「￹入力￺にゅうりょく￻ソース」に、「￹日本語￺にほんご￻ (Hiragana IME)」を￹追加￺ついか￻します。

![設定—キーボード](settings-keyboard.png)

### GNOME￹以外￺いがい￻を￹利用￺りよう￻しているとき

　「IBusの￹設定￺せってい￻」ウィンドウをひらいて、「￹入力￺にゅうりょく￻メソッド」タブの「￹入力￺にゅうりょく￻メソッド」に、
<br><br>
　　![アイコン](icon.png) ￹日本語￺にほんご￻ - Hiragana IME
<br><br>
を￹追加￺ついか￻します。

## 「ひらがなIME」を￹有効￺ゆうこう￻にする {: #enable}

　IBusでは、￹複数￺ふくすう￻のIMEをきりかえて、つかうことができます。
　「ひらがなIME」を￹有効￺ゆうこう￻するには、デスクトップ シェルの「キーボード メニュー」をひらいて、「日本語 (Hiragana IME)」をえらびます。
「キーボード メニュー」は、トップバーの￹現在￺げんざい￻の￹入力￺にゅうりょく￻メソッドを￹表示￺ひょうじ￻している￹部分￺ぶぶん￻（「<nobr>ja</nobr>｣，｢<nobr>あ</nobr>」など）をクリックしてひらきます。

![キーボード メニュー](keyboard-menu.png)

　なお、「ひらがなIME」は￹直前￺ちょくぜん￻に￹指定￺してい￻されていたキーボード レイアウトをつかって￹動作￺どうさ￻するようになっています。

- ￹日本語￺にほんご￻キーボードを￹利用￺りよう￻するときは、まず、￹入力￺にゅうりょく￻ソースから「￹日本語￺にほんご￻」を￹選択￺せんたく￻します。そのあとで、￹入力￺にゅうりょく￻ソースから「￹日本語￺にほんご￻(Hiragana IME)」を￹選択￺せんたく￻します。
- ￹英語￺えいご￻(US)キーボードを￹利用￺りよう￻するときは、まず、￹入力￺にゅうりょく￻ソースから「￹英語￺えいご￻(US)」を￹選択￺せんたく￻します。そのあとで、￹入力￺にゅうりょく￻ソースから「￹日本語￺にほんご￻(Hiragana IME)」を￹選択￺せんたく￻します。

　￹使用￺しよう￻するキーボードのレイアウトがみつからないときは、GNOMEの「￹設定￺せってい￻」をひらいて、「キーボード」の「￹入力￺にゅうりょく￻ソース」にレイアウトを￹追加￺ついか￻してください。
「ひらがなIME」は、いまのところ、「￹日本語￺にほんご￻」,「￹英語￺えいご￻(US)」,「￹英語￺えいご￻(Dvorak)」の３つのキーボード レイアウトをサポートしています。

<br>
**メモ**: キーボードは￹国￺くに￻や￹言語￺げんご￻によってスイッチのレイアウトがことなります。
￹日本￺にほん￻では、￹日本語￺にほんご￻キーボードのほかに￹英語￺えいご￻(US)キーボードも￹利用￺りよう￻されています。
￹英語￺えいご￻(US)キーボードは、アメリカで￹一般的￺いっぱんてき￻につかわれているキーボードです。
USはUnited States (of America)の￹略￺りゃく￻です。
￹英語￺えいご￻キーボードでも、イギリスのものはアメリカのものとまたすこしキーボード レイアウトがちがいます。

## ￹大規模￺だいきぼ￻￹言語￺げんご￻モデルのインストール {: #llm}

　「ひらがなIME」には、￹大規模￺だいきぼ￻￹言語￺げんご￻モデル(LLM)を￹利用￺りよう￻して、かな￹漢字￺かんじ￻￹変換￺へんかん￻をアシストする￹機能￺きのう￻があります。
この￹機能￺きのう￻を￹有効￺ゆうこう￻にするには、つぎのようなパッケージを￹追加￺ついか￻でインストールする￹必要￺ひつよう￻があります。

- [Huggingface Transformers](https://huggingface.co/docs/transformers/ja/installation)
- [tohoku-nlp/bert-base-japanese-v3](https://huggingface.co/tohoku-nlp/bert-base-japanese-v3)

　「ひらがなIME」は、Pythonの￹仮想￺かそう￻￹環境￺かんきょう￻のなかで￹実行￺じっこう￻されています。
この￹仮想￺かそう￻￹環境￺かんきょう￻のなかに￹上記￺じょうき￻のパッケージをインストールするには、つぎのようにします。

1. 「[ひらがなIMEの￹設定￺せってい￻](settings.html#ibus-setup-hiragana)」ウィンドウで、「オプション」タブをひらきます。

![「ひらがなIMEの設定」ウィンドウ](ibus-setup-hiragana_3.png)

2. [インストール...]をクリックすると、つぎのようなウィンドウがひらきます。

![ポストインストール ウィンドウ](postinst_1.png)

3. [インストール]をクリックすると、パッケージのダウンロードとインストールがはじまります。
ウィンドウ￹内￺ない￻にはインストールの￹経過￺けいか￻が￹表示￺ひょうじ￻されます。
インストールが￹完了￺かんりょう￻して、￹右￺みぎ￻￹下￺した￻のボタンが[とじる]にかわったら、クリックしてウィンドウをとじます。

![ポストインストール ウィンドウ](postinst_2.png)

4. 「[ひらがなIMEの￹設定￺せってい￻](settings.html#ibus-setup-hiragana)」ウィンドウの「オプション」タブで、「￹変換￺へんかん￻￹候補￺こうほ￻の￹選択￺せんたく￻にLLMを￹利用￺りよう￻する」をオンにします。

![「ひらがなIMEの設定」ウィンドウ](ibus-setup-hiragana_5.png)

　NVIDIAのGPUを￹搭載￺とうさい￻しているPCでは、[CUDA](settings.html#cuda)をつかってLLMの￹計算￺けいさん￻を￹高速￺こうそく￻￹化￺か￻することができます。CUDAをつかうときは、「LLMの￹計算￺けいさん￻にCUDAを￹利用￺りよう￻する」もオンにします。

<!--
<br>**￹注意￺ちゅうい￻**: CUDAを￹使用￺しよう￻するばあいは、NVIDIAドライバーの[￹電源￺でんげん￻￹管理￺かんり￻の￹設定￺せってい￻](https://download.nvidia.com/XFree86/Linux-x86_64/550.67/README/powermanagement.html)もあわせておこなってください。￹設定￺せってい￻しておかないと、サスペンド￹状態￺じょうたい￻からレジュームしたあと、￹漢字￺かんじ￻￹変換￺へんかん￻ができなくなることがあります。
<br>※ <code>NVreg_PreserveVideoMemoryAllocations=1</code>オプションなどの￹設定￺せってい￻が￹必要￺ひつよう￻です。
-->

5. [OK]をクリックして、「[ひらがなIMEの￹設定￺せってい￻](settings.html#ibus-setup-hiragana)」ウィンドウをとじます。
LLMを￹利用￺りよう￻するために￹必要￺ひつよう￻なパッケージのインストールと￹設定￺せってい￻はこれで￹完了￺かんりょう￻です。

<br>**ヒント**: [￹情報￺じょうほう￻ダイアログボックス](usage.html#about)をひらくと、「ひらがなIME」がLLMを￹使用￺しよう￻しているかどうか￹確認￺かくにん￻できます。

## アップデートのしかた {: #update}

　あたらしいバージョンの「ひらがなIME」をリリースしたときは、GitHubの[Releases](https://github.com/esrille/ibus-hiragana/releases)ページからおしらせしています。
インストールした￹手順￺てじゅん￻にあった￹方法￺ほうほう￻でソフトウェアのアップデートをおこなってください。

### Fedoraのばあい

　そのほかのFedoraのパッケージとおなじようにアップデートされます。コマンドラインからは、つぎのdnfコマンドでアップデートできます。

```
sudo dnf update
```

### Ubuntuのばあい

　そのほかのUbuntuのパッケージとおなじようにアップデートされます。コマンドラインからは、つぎのaptコマンドでアップデートできます。

```
sudo apt update
sudo apt upgrade
```

<br>**￹注意￺ちゅうい￻**: OSにインストールされているPythonもアップデートされることがあります。
Pythonがアップデートされたときは、「ひらがなIME」も￹仮想￺かそう￻￹環境￺かんきょう￻で￹使用￺しよう￻するPythonを￹更新￺こうしん￻します。
そのとき、LLMパッケージの￹再￺さい￻インストールが￹必要￺ひつよう￻になります。
したのような￹通知￺つうち￻がデスクトップに￹表示￺ひょうじ￻されたときは、LLM￹関連￺かんれん￻のパッケージを￹再￺さい￻インストールしてください。

<br>
　　![デスクトップ通知](notification.png)

## アンインストールのしかた {: #uninstall}

　「ひらがなIME」のアンインストールは、インストールした￹方法￺ほうほう￻にあわせて、おこなってください。

### Fedoraのばあい

　dnfコマンドで「ひらがなIME」をアンインストールします。

```
sudo dnf remove ibus-hiragana
```

### Ubuntuのばあい

　aptコマンドで「ひらがなIME」をアンインストールします。
```
sudo apt remove ibus-hiragana
```

## ホームディレクトリ￹内￺ない￻に￹保存￺ほぞん￻されるユーザーのデータについて {: #user-files}

　「ひらがなIME」は、ディレクトリ <code>~/.local/share/ibus-hiragana/</code> のなかに、￹漢字￺かんじ￻￹変換￺へんかん￻の￹学習￺がくしゅう￻￹結果￺けっか￻などを￹保存￺ほぞん￻しています。
また、「ひらがなIME」が￹使用￺しよう￻するPythonの￹仮想￺かそう￻￹環境￺かんきょう￻もこのディレクトリのなかにあります。

```
~/.local/share/ibus-hiragana/
├── dic/        # 辞書の学習結果
├── my.dic      # 個人辞書ファイル
└── venv/       # ひらがなIME用のPythonの仮想環境
```

　「ひらがなIME」を￹複数￺ふくすう￻のパーソナルコンピューターで￹使用￺しよう￻するときは、ディレクトリ <code>dic</code> や <code>my.dic</code> をコピーして￹使用￺しよう￻することもできます。

### クリーンアップ￹方法￺ほうほう￻

　「ひらがなIME」をアンインストールしたときは、ディレクトリ <code>~/.local/share/ibus-hiragana/</code> をまるごと￹削除￺さくじょ￻してかまいません。

```
rm -rf ~/.local/share/ibus-hiragana
```

　また、かな￹漢字￺かんじ￻￹変換￺へんかん￻に￹大規模￺だいきぼ￻￹言語￺げんご￻モデルを￹利用￺りよう￻しているばあいは、[tohoku-nlp/bert-base-japanese-v3](https://huggingface.co/tohoku-nlp/bert-base-japanese-v3) のファイルが、ディレクトリ <code>~/.cache/huggingface/hub/models--cl-tohoku--bert-base-japanese-v3/</code> のなかに￹保存￺ほぞん￻されています。
このファイルは、ひらがなIME￹以外￺いがい￻の[Transformers](https://huggingface.co/docs/transformers/ja/index)を￹利用￺りよう￻しているアプリが￹利用￺りよう￻していることがあります。
「ひらがなIME」のほかに、そのようなアプリがなければ、このディレクトリも￹削除￺さくじょ￻してかまいません。

```
rm -rf ~/.cache/huggingface/hub/models--cl-tohoku--bert-base-japanese-v3
```

